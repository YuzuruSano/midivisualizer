# MIDI Visualizer Project - Claude Code Memory

## プロジェクト概要
openFrameworksベースのドラム最適化MIDIビジュアライザー。都市・コンクリートテーマの累積成長システム。

## アーキテクチャ
- 7つのビジュアルシステム（Particles, Fractals, Waves, Flow Field, L-System, Reaction-Diffusion, Differential Growth）
- 統一成長システム（globalGrowthLevel: 0.0 → 1.0 → 崩壊 → 再生）
- FBOベースの全画面エフェクト（beginMasterBuffer/endMasterBuffer）
- ドラム特化MIDI処理（KICK, SNARE, HIHAT_CLOSED, CRASH）

## ビジュアルシステムの再生順序
1. **ParticleSystem** - パーティクルシステム（都市の塵、光の粒子）
2. **FractalSystem** - フラクタルシステム（都市の自己相似構造）
3. **WaveSystem** - ウェーブシステム（都市の波動、振動）
4. **FlowFieldSystem** - フローフィールドシステム（都市の流れ、交通）
5. **LSystemSystem** - L-システム（建設現場、都市開発、クレーン）
6. **DifferentialGrowthSystem** - 差分成長システム（メトロポリタン発展）
7. **ReactionDiffusionSystem** - 反応拡散システム（都市セルラーオートマトン）

## 開発状況
### 完了済み
- ✅ セグメンテーションフォルト修正（ReactionDiffusionSystemのシェーダー除去）
- ✅ システム5-7の革新的発展：
  - **LSystemSystem**: 建設現場・都市開発（クレーン、足場、青写真）
  - **ReactionDiffusionSystem**: 都市セルラーオートマトン（人口密度、経済活動、インフラ）
  - **DifferentialGrowthSystem**: メトロポリタン発展（ノードタイプ、交通網、メガプロジェクト）
- ✅ APIコンパチビリティ修正（normalized() → getNormalized(), addVertex()）
- ✅ 統一アーキテクチャ適用（全システムに成長システム統合）
- ✅ ビジュアル密度の大幅削減（全システム50-70%の要素数削減、スペーシング拡大）
- ✅ クロスフェード切替機能（4秒間のゆったりとした切り替え、コサインイージング）
- ✅ MIDIテンポ検出機能（KICKドラムからBPM自動検出）
- ✅ 8小節自動切替機能（テンポ同期での自動シーン切替）
- ✅ ホワイトアウト問題修正（System 6-7の明度制限実装）

### ビルド情報
- コンパイルコマンド: `make MAC_OS_CPP_VER="-std=c++17"`
- 作業ディレクトリ: `/Users/yuzuru-sano/of_v0.12.1_osx_release/apps/myApps/midiVisualizer`
- バイナリ: `bin/midiVisualizer.app`

### 技術的詳細
- **描画システム**: FBOベースマスターバッファ、ALPHAブレンドモード（ADD除去）
- **成長システム**: globalGrowthLevel (0.0→1.0) による統一進化制御
- **MIDI処理**: リアルタイムドラム検出、BPM自動算出、8小節同期切替
- **クロスフェード**: 4秒コサインイージング、自然なシーン遷移
- **色彩管理**: モノトーン+アクセント方式、ホワイトアウト完全防止
- **物理演算**: 振り子物理、流体シミュレーション、差分成長アルゴリズム
- **API互換性**: openFrameworks 0.12.1対応、deprecated メソッド更新

### カラーシステム（2024-06-30改造版）
**モノトーンベース + アクセントカラー方式**

#### System 6: DifferentialGrowthSystem
- **モノトーン**: グレー系（50-140範囲）- 住宅・工業地区
- **アクセント1**: ソフトブルー（60, 90-130, 120-150）- 商業地区
- **アクセント2**: シアン（40, 100-140, 110-140）- 交通ハブ
- **アクセント3**: ウォームグレー（100-130, 90-115, 80-100）- ランドマーク

#### System 7: ReactionDiffusionSystem
- **モノトーン**: ダークグレー・ライトグレー（60-140範囲）- 基本都市セル
- **アクセント1**: ブルー（60, 90-120, 130-155）- 高度発達地区
- **アクセント2**: シアン（50, 110-140, 120-145）- 商業地区
- **アクセント3**: ライトイエロー（160, 150, 120）- 建物窓

#### 特別演出
- **ランダムフラッシュ**: 3秒間隔、2%確率で白フラッシュ
- **CRASH時フラッシュ**: 即座に眩しい演出（クラッシュシンバル連動）

### 今回のセッション成果（2024-06-30）
#### ✅ 完全解決された課題
1. **ホワイトアウト問題の根絶**: System 6-7の白飛び完全解決
2. **視覚的安定性**: モノトーンベースによる長時間安定表示
3. **描画システム最適化**: ADDブレンドモード全面除去
4. **色彩システム刷新**: 上品なモノトーン+アクセント方式

#### 🎨 革新的改良点
- **System 5 (L-System)**: 振り子物理、繊維束地面、建設要素の大型化
- **System 3 (Wave)**: 流体的相互作用背景、ベクターフィールド改良
- **System 6-7**: 完全なカラーシステム再設計
- **演出システム**: ランダムフラッシュ、CRASH連動演出

### 次回のセッション用メモ
1. システム1-4のさらなる革新的発展検討
2. パフォーマンス最適化とメモリ効率化
3. 追加的なMIDIコントローラー対応（CC、Pitchbend等）
4. より複雑な都市現象の実装（経済循環、季節変化等）
5. エクスポート機能（画像・動画出力）の追加検討

### 課題解決履歴
- **2024-06-23**: スペースキー切り替え時のセグメンテーションフォルト → ReactionDiffusionSystemシェーダー除去で解決
- **2024-06-23**: openFrameworks API変更対応 → deprecated メソッド更新
- **2024-06-29**: ビジュアル密度過多問題 → 全システムの要素数とスポーン頻度を50-70%削減、グリッドスペーシング拡大
- **2024-06-30**: ホワイトアウト問題修正 → DifferentialGrowthSystem/ReactionDiffusionSystemに明度制限とアルファ値削減適用
- **2024-06-30**: ホワイトアウト問題追加修正 → より暗い色調設定（明度70%→30%削減）、彩度向上（1.3-1.5倍）で高コントラスト化
- **2024-06-30**: ホワイトアウト問題根本修正 → 全ADDブレンドモードをALPHAモードに変更、アルファ値を極限まで削減（15-30範囲）
- **2024-06-30**: カラーシステム全面改造 → モノトーン（グレー系）＋アクセントカラー（ブルー・シアン・ウォーム系）方式に変更、ランダムフラッシュ演出追加

### ビジュアル密度削減の詳細
**ParticleSystem**: パーティクル生成率 15→5、最大数 800→250、爆発エフェクト密度削減、アトラクター間隔拡大
**WaveSystem**: 波レイヤー 7→3、解像度 300→120、構造線 20→8、エフェクト粒子削減
**FlowFieldSystem**: ベース粒子数 800→320、グリッドスケール 20→40、スポーン率大幅削減
**LSystemSystem**: 建設サイト削減、足場密度削減、構造制限 500→150、エフェクト要素削減
**ReactionDiffusionSystem**: セルサイズ 4→8、初期核 3→2、エフェクト要素大幅削減、ゾーン間隔拡大
**DifferentialGrowthSystem**: 初期ノード 12→6、最大ノード 300→120、間隔拡大、接続頻度削減

### グリッチエフェクトシステム実装（2025-06-30）
#### ✅ 実装内容
1. **ofxPostGlitchライブラリ統合**: GitHubから最新版を取得・導入
2. **GlitchAreaSystem実装**: エリア限定グリッチエフェクトシステム
   - 円形エリアベースのグリッチ適用
   - グラデーションマスクによる自然なブレンド
   - 16種類のグリッチエフェクトタイプ対応
3. **Push2 MIDIインテグレーション**: パッド92-99でグリッチトリガー
4. **ライフタイム管理**: 2-4秒の自動フェードイン・フェードアウト
5. **マルチエリア対応**: 同時に2-3個のランダムエリア生成

#### 🎮 操作方法
- **Push2パッド92-99**: グリッチエフェクトトリガー
- **キーボード'G'**: テスト用グリッチトリガー
- **自動生成**: 2-3個のランダムエリアに数秒間グリッチ適用

#### 技術的詳細
- **レンダリングパイプライン**: FBOベースのポストプロセッシング統合
- **エフェクトタイプ**: CONVERGENCE, SHAKE, CUT_SLIDER, TWIST等16種類
- **パフォーマンス最適化**: エリア限定処理により全画面エフェクトより軽量
- **ウィンドウリサイズ対応**: 動的FBO再割り当て

### グリッチエリア拡張機能（2025-06-30 追加）
#### ✅ 大型化・トレイル機能
1. **エリアサイズ拡大**: 150-350ピクセルの大型グリッチエリア
2. **移動軌跡トレイル**: 最大40ポイントの移動軌跡を保持
3. **形状継承トレイル**: エリアと同じ形状（円・楕円・矩形・ダイヤ・三角）でトレイル描画
4. **トレイルフェード**: 2秒間かけて徐々に透明化・縮小
5. **インテリジェント生成**: 5ピクセル以上移動時のみトレイル生成

#### 🎨 視覚効果
- **ダイナミックサイジング**: トレイルは時間経過で30-100%のサイズ変化
- **透明度調整**: メインエリアの30%の透明度でトレイル表示
- **回転同期**: メインエリアの回転と連動したトレイル回転
- **形状統一**: 全てのトレイルポイントがエリアと同じ形状を維持

#### 📐 トレイル管理
- **更新間隔**: 0.05秒ごとの軌跡記録
- **自動クリーンアップ**: 古いトレイルポイントの自動削除
- **メモリ効率**: 固定最大数による効率的なメモリ使用

### サーチライト移動パターン強化（2025-06-30 追加）
#### 🎯 発生確率調整
- **SPOTLIGHT_SCAN**: 70%（40%→70%に大幅増加）
- **RANDOM_WALK**: 20%（30%→20%に調整）
- **LINEAR_SWEEP**: 10%（新規追加）
- **その他パターン**: 稀少（CIRCULAR_ORBIT, ZIGZAG, STATIC）

#### ⚡ 移動性能向上
- **移動速度**: 40-120ピクセル/秒（30-100から高速化）
- **縦移動速度**: 水平移動の40%（30%から向上）
- **反転時ランダム性**: 30%確率で縦方向も反転する動的挙動
- **よりアクティブ**: 画面端での反射時に予測不可能な動きを追加

### ダイナミック緩急システム（2025-06-30 追加）
#### 🎬 大胆な緩急効果
1. **急加速バースト**: 反転時に2-4倍速の急加速（0.5-1.5秒持続）
2. **一時停止**: 50%確率で0.3-1.5秒の劇的な停止
3. **3段階速度変化**: 低速（10-40）、中速（50-100）、高速（120-300）ピクセル/秒
4. **easeInOutQuart**: 急激な加減速カーブによる映画的効果

#### ⏱️ 大幅延長された持続時間
- **ライフタイム**: **3-6秒 → 8-15秒**に大幅延長
- **トレイル持続**: 2秒 → 3秒に延長
- **トレイルポイント**: 40 → 60ポイントに増加
- **より長期間**: サーチライト効果をじっくり楽しめる

#### 🎯 インテリジェント動作
- **自動緩急**: 0.3%/秒の確率でランダムな速度変化
- **反転連動**: 画面端到達時の自動スピードバースト
- **停止明け加速**: 一時停止後の自動急加速
- **回転同期**: 移動速度に応じた回転速度調整